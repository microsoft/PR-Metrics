# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

---
name: Release – Phase 2

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/support/release-phase-2-trigger.txt
  workflow_dispatch: null

permissions: {}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@6c439dc8bdf85cadbbce9ed30d1c7b959517bc49 # v2.12.2
        with:
          disable-sudo: true
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get Version
        id: version
        shell: pwsh
        run: |-
          $Version = Get-Content -Path '.github/workflows/support/release-phase-2-trigger.txt'
          Write-Output -InputObject "VERSION=v$Version" >> $Env:GITHUB_OUTPUT

      - name: Update LICENSE.txt
        shell: pwsh
        run: |-
          $FilePath = 'src/LICENSE.txt'
          $FileContents = Get-Content -Path $FilePath
          $Index = [Array]::IndexOf($FileContents, ($FileContents | Where-Object { $_ -match 'NOTICES AND INFORMATION' }))
          $Index -= 1
          $FileContents = $FileContents[0..$Index]
          Set-Content -Path $FilePath -Value $FileContents

      - name: Update release-phase-3-trigger.txt
        shell: pwsh
        run: Set-Content -Path '.github/workflows/support/release-phase-3-trigger.txt' -Value ${{ steps.version.outputs.VERSION }}

      - name: Git Setup & Push
        uses: ./.github/actions/git-setup-and-push
        with:
          phase: 2
          version: ${{ steps.version.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: PR – Create
        run: >-
          gh pr create
          --title "Release v${{ steps.version.outputs.VERSION }}"
          --body "Release for PR Metrics v${{ steps.version.outputs.VERSION }}. This includes the license updates."
          --label "release"
          --assignee "${{ github.actor }}"
          --reviewer "${{ github.actor }}"
        env:
          # Fine-grained Personal Access Token (PAT) with the following permissions for microsoft/PR-Metrics:
          # - Read access to Metadata
          # - Read and Write access to Pull Requests
          GITHUB_TOKEN: ${{ secrets.RELEASE_PR_CREATE }}

      - name: PR – Comment
        run: gh pr comment --body-file "./.github/workflows/support/release-phase-2-comment.md"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# PR Metrics

PR Metrics is an Azure Pipelines task for adding size and test coverage
indicators to the start of each Pull Request title.

It can be downloaded from the Visual Studio Marketplace at
<https://marketplace.visualstudio.com/items?itemName=ms-omex.prmetrics>.

For example, a PR with the title "Adding code" could become either:

- XS:heavy_check_mark: :black_small_square: Adding code
- L:warning: :black_small_square: Adding code

The former would indicate an extra small PR with sufficient test coverage,
whereas the latter would indicate a large PR with insufficient test coverage.

This task helps ensure engineers keep PRs to an appropriate size with
appropriate test coverage, while informing reviewers of the expected time
commitment for a thorough review of the code.

The task will also add a comment to the PR with a detailed breakdown of the
metrics:

> **Metrics for iteration 1**
> :heavy_check_mark: Thanks for keeping your pull request small.
>
> :heavy_check_mark: Thanks for adding tests.
>
> |              | Lines   |
> | ------------ | ------: |
> | Product Code |   100   |
> | Test Code    |    50   |
> | **Subtotal** | **150** |
> | Ignored      |     5   |
> | **Total**    | **155** |

It will furthermore add a comment to indicate that a review of the file is
unnecessary.

> :exclamation: **This file doesn't require review.**

If no PR description is provided, the description will be set to:

> :x: **Please add a description.**

The extension will also add properties to the PR, which can be queried by other
extensions as desired:

- `/PRMetrics.Size`: A string representing the size indicator, e.g. `XS`.
- `/PRMetrics.TestCoverage`: A Boolean value indicating whether the test
  coverage is deemed sufficient. If no test coverage is expected (i.e. if the
  test factor input is set to `0.0`), this property will not be present.
- `/PRMetrics.ProductCode`: An integer indicating the number of lines of product
  code added via the PR.
- `/PRMetrics.TestCode`: An integer indicating the number of lines of test
  code added via the PR.
- `/PRMetrics.Subtotal`: An integer indicating the number of lines of product
  and test code added via the PR. This is the sum of `/PRMetrics.ProductCode`
  and `/PRMetrics.TestCode`.
- `/PRMetrics.Ignored`: An integer indicating the number of lines of ignored
  code added via the PR. This includes files ignored through the use of the code
  matching patterns input, as well as those files whose extensions resulted in
  their being ignored.
- `/PRMetrics.Total`: An integer indicating the total number of lines of code
  added via the PR. This is the sum of `/PRMetrics.Subtotal` and
  `/PRMetrics.Ignored`.

## Deploying

The task can be used with [Azure Pipelines][azurepipelines].

To deploy the task:

1. Acquire administrator access to the server to which you wish to deploy.
1. Install [tfx-cli][tfxcli] using [npm][npm] via the command-line
   `npm install -g tfx-cli`.
1. Sign in to the server using:

   ```bat
   tfx login --service-url https://<account>.visualstudio.com/DefaultCollection --token <PAT>
   ```

   You can generate a PAT with at least the "Agent Pools (Read & manage)" scope
   by following the instructions [here][tfxpat]. This will only need to be
   performed the first time you use tfx-cli.
1. To build and deploy, from within the `buildTask` folder, run
   `npm run deploy`.

## Configuring

The task can be added to a pipeline as detailed [here][addingtask].

The agent running the task must allow access to the OAuth token. If access is
unavailable, the task will generate an error.

It is recommended to run the task as one of the first operations in your build,
after code check out is complete. Running the task early in the build process
allows for the title to be updated quickly, avoiding the need for engineers to
wait a long time for the title update.

### Inputs

The task inputs are:

- **Base Size:** The maximum number of new lines in a small PR. If left blank,
  a default of `250` will be used.
- **Growth Rate:** The growth rate applied to the base size for calculating the
  size of larger PRs. If left blank, a default of `2.0` will be used. With a
  base size of `250` and a growth rate of `2.0`, `500` new lines would
  constitute a medium PR while `1000` new lines would constitute a large PR.
- **Test Factor:** The lines of test code expected for each line of product
  code. If left blank, a default of `1.5` will be used. This can be set to `0.0`
  in order to skip the reporting of whether the test code coverage is
  sufficient.
- **File Matching Patterns:** [Azure DevOps file matching patterns][globs]
  specifying the files and folders to include. Autogenerated files should
  typically be excluded. Excluded files will contain a comment to inform
  reviewers that they are unlikely to need to review those files. If left
  blank, a default of `**/*` (all files) will be used.
- **Code File Extensions:** Extensions for files containing code, so that
  non-code files can be excluded. If left blank, a default set of file
  extensions will be used, which are listed at
  [the end of this file](#default-code-file-extensions).

### YAML

The default input values are expected to be appropriate for most builds.
Therefore, the following YAML definition is recommended:

```YAML
steps:
- task: ms-omex.prmetrics.prmetrics.PRMetrics@1
  displayName: 'PR Metrics'
  continueOnError: true
```

If you wish to modify the inputs, YAML akin the to the following can be used:

```YAML
steps:
- task: ms-omex.prmetrics.prmetrics.PRMetrics@1
  displayName: 'PR Metrics'
  inputs:
    BaseSize: 250
    GrowthRate: 2.0
    TestFactor: 1.5
    FileMatchingPatterns: |
      **/*
      !Ignore.cs
    CodeFileExtensions: |
      cs
      ps1
  continueOnError: true
```

## Implementation

This task is written in [TypeScript][typescript] using the
[Azure Pipelines Task SDK][sdk].

It works by querying Git for changes using the command
`git diff --numstat origin/<target>...pull/<pull_request_id>/merge`. Files with
`test` in the file or directory name (irrespective of case) are considered test
files. All other files are considered product code files.

Note that this task is designed to give a quick estimate of the size of a change
and its test coverage. It is not an authoritative metric and should not be
treated as such. For example, the task should not be used to replace
comprehensive and thorough code coverage metrics. Instead, the task should
merely be considered a guideline for influencing optimal PR behavior.

The task can be built using `npm run build` from the `buildTask`
folder. `npm run clean` can be used to clean the build outputs.

## Testing

This task is tested via unit and integration tests constructed using the
[Mocha][mocha] test framework, the [Chai][chai] assertion library and the
[ts-mockito][tsmockito] mocking library. Tests follow the
[Arrange-Act-Assert pattern][aaa], and they can be run using `npm test` from
within the `buildTask` folder. This command will output both the test
results and code coverage metrics.

The code coverage is currently extremely high, and a high rate of coverage
should be maintained for all changes. There are a large number of edge cases
which were only discovered through experience and the unit tests ensure that
these edge case solutions do not regress. Moreover, validating this extension on
the server is significantly more time consuming than validating locally.

You can use `npm run debug` for limited local testing, and `npm run deploy` for
server-based testing.

The code formatting complies with the [ESLint][eslint] "Standard" rules. The
formatting can be checked and automatically fixed by running `npm run lint`
from within the `buildTask` folder. [TypeDoc][typedoc] comments are
present on public methods and are converted to HTML during the `npm run build`
process. [Dependency injection][depinjection] is used throughout the project to
facilitate testability.

Test validation and code scanning will be automatically performed whenever a
PR is opened against the `main` branch. These validations must succeed for the
PR to be merged.

### Manual Test Cases

Unfortunately, it is not possible to automatically test everything. Therefore,
it is recommended that you perform the following manual test cases whenever
significant changes are made. These don't cover all possible scenarios, but they
should combine with the unit tests to provide a high level of coverage.

1. Create an [Azure Pipelines build task][docsbuildtask] including PR Metrics.
   Do not allow [access to the OAuth token][docsoauth]. Run the pipeline against
   any branch. Ensure that the task is skipped as it is not running against a
   PR.
1. Make your build task a [requirement for a custom branch][docsbranch], and
   create a PR against that branch. In the PR:
   - create `file.ts` with 10 lines
   - create `fileTest.cs` with 30 lines
   - create `file.ignored` with 30 lines
   - rename an existing file in the repo to `temporary1.ts`
   - rename an existing file in the repo to `temporary2.ts`, keeping the file
     in its original folder
   - add 5 lines to `temporary2.ts`
   Clear the description. After creating the PR, check the status of the build
   task. It should fail with an error as the OAuth token cannot be accessed.
1. Modify the build task definition to provide
   [access to the OAuth token][docsoauth]. Go back to your PR and click
   "Re-queue" next to the build failure. This time, the task should succeed. The
   title should be prefixed with "XS:heavy_check_mark: :black_small_square:",
   the description should be changed to ":x: Please add a description.", and
   the metrics comment should be added to the PR with the following details:
   - :heavy_check_mark: Thanks for keeping your pull request small.
   - :heavy_check_mark: Thanks for adding tests.
   - Product code: 16
   - Test code: 30
   - Subtotal: 46
   - Ignored: 30
   - Total: 76
   The metrics comment thread should be closed.
1. Modify the build task definition to change the inputs to the following:
   - Base size: 2
   - Growth rate: 2
   - Test factor: 100
   - File matching patterns: \*\*/file*
   - Code file extensions: ts
   Push a new change to the build, adding 1 more line to `file.ignored`. The
   build will re-run and you should see the title prefix updated to
   "L:warning: :black_small_square:". A new comment corresponding to the new
   iteration will be added to the thread, which should have the following
   details:
   - :x: Try to keep pull requests smaller than 2 lines of new product code by
     following the Single Responsibility Principle (SRP).
   - :warning: Consider adding additional tests.
   - Product code: 10
   - Test code: 0
   - Subtotal: 10
   - Ignored: 67
   - Total: 77
   The metrics comment thread should be active. `temporary1.ts` and
   `temporary2.ts` should both include the closed comment
   ":exclamation: This file doesn't require review."
1. Modify the build task definition to change the "test factor" input to "0"
   (not blank). Push a new change to the build, adding 1 more line to
   `file.ignored`. The build will re-run and you should see the title prefix
   updated to "L :black_small_square:". A new comment corresponding to the new
   iteration will be added to the thread, which should have the following
   details:
   - :x: Try to keep pull requests smaller than 2 lines of new product code by
     following the Single Responsibility Principle (SRP).
   - Product code: 10
   - Test code: 0
   - Subtotal: 10
   - Ignored: 68
   - Total: 78
   The metrics comment thread should be active.
1. Without pushing addition changes, go back to your PR and click "Re-queue"
   next to the build. The build should success but no changes should be made to
   the PR.

## Debugging

To gain greater insight into the cause of failures, you can set the
`system.debug` variable to `true` for your build pipeline. This will output
significant additional debugging information, including a full trace of the
methods called, which can be used for posting bug reports, etc.

If a failure occurs during the task, full debugging information will be
outputted by default irrespective of the value of the `system.debug` variable.

## Default Code File Extensions

The default value for the Code File Extensions input outlined
[above](#inputs) is:

```Text
ada
adb
ads
asm
bas
bb
bmx
c
cbl
cbp
cc
clj
cls
cob
cpp
cs
cxx
d
dba
e
efs
egt
el
f
f77
f90
for
frm
frx
fth
ftn
ged
gm6
gmd
gmk
gml
go
h
hpp
hs
hxx
i
inc
java
js
jsx
l
lgt
lisp
m
m4
ml
msqr
n
nb
p
pas
php
php3
php4
php5
phps
phtml
piv
pl
pl1
pli
pm
pol
pp
prg
pro
py
r
rb
red
reds
rkt
rktl
rs
s
scala
sce
sci
scm
sd7
skb
skc
skd
skf
skg
ski
skk
skm
sko
skp
skq
sks
skt
skz
spin
stk
swg
tcl
ts
tsx
vb
xpl
xq
xsl
y
```

[azurepipelines]: https://azure.microsoft.com/services/devops/pipelines/
[azureserver]: https://azure.microsoft.com/services/devops/server/
[tfxcli]: https://github.com/Microsoft/tfs-cli
[npm]: https://www.npmjs.com/
[tfxpat]: https://docs.microsoft.com/azure/devops/extend/publish/command-line
[vssextensionjson]: vss-extension.json
[taskjson]: buildTask/task.json
[addingtask]: https://docs.microsoft.com/azure/devops/pipelines/customize-pipeline
[globs]: https://docs.microsoft.com/azure/devops/pipelines/tasks/file-matching-patterns
[typescript]: https://www.typescriptlang.org/
[sdk]: https://github.com/microsoft/azure-pipelines-task-lib
[mocha]: https://mochajs.org/
[chai]: https://www.chaijs.com/
[aaa]: https://automationpanda.com/2020/07/07/arrange-act-assert-a-pattern-for-writing-good-tests/
[tsmockito]: https://github.com/NagRock/ts-mockito
[eslint]: https://eslint.org/
[typedoc]: https://typedoc.org/
[depinjection]: https://wikipedia.org/wiki/Dependency_injection
[docsbuildtask]: https://docs.microsoft.com/azure/devops/pipelines/create-first-pipeline
[docsoauth]: https://docs.microsoft.com/azure/devops/pipelines/build/options#allow-scripts-to-access-the-oauth-token
[docsbranch]: https://docs.microsoft.com/azure/devops/repos/git/branch-policies#build-validation
